# 要件定義書

**テーマ**: Electron + three.js + MediaPipe Tasks（Hand Landmarker）で、カメラ映像にMMDモデル（.pmx + .png）を合成し、**WebXR Hit Test**（可能な環境）または**スクリーン座標Fallback**で「掴む／移動／回転／拡大縮小」を操作できるPoCを構築する。
**追加重視点**: モデル\*\*追加（ユーザ選択で読み込み）\*\*の明確化、1080p基準、A/B二系統（XR/Fallback）の自動切替、性能・信頼性・法令/規約面の実装要件を増補。

---

## 0. 変更点サマリ（本版での追補）

* モデル**追加UI/UX**（メニュー／ドラッグ&ドロップ／最近使った項目／読み込み検証）を定義。
* **資産リゾルバ**（.pmx から相対参照される .png などの解決、パス正規化、重複ロード防止）を定義。
* WebXR Hit Test（A系）とスクリーン座標（B系）の**機能境界**・**自動切替**・**受入基準**を詳細化。
* **1080p要求**＋**推論用内部解像度**の分離設計、fps/遅延の目標値、ヘルス・メトリクス（HUD）を明記。
* IPC契約・設定スキーマ・ディレクトリ構成・セキュリティ（Electron）・ライセンス/規約遵守を補強。
* ジェスチャー検出（ピンチ／両手距離／手首向き）と**平滑化**（EMA/One Euro）の係数・式を具体化。
* テスト観点（失敗系/境界条件）・受入判定・リスク/回避策を拡充。

---

## 1. 目的・スコープ

### 1.1 目的

* **マーカー不要**の自然な配置体験を**WebXR Hit Test**で実現（対応環境）。
* 非対応環境では**スクリーン座標Fallback**で同等の操作UXを提供。
* **手ジェスチャー**で「掴む／移動／拡大縮小／回転」を**安定・低遅延**で制御。

### 1.2 スコープ（今回やること）

1. Electronアプリ起動／権限管理（カメラ）
2. **A: XR層**（`immersive-ar` + Hit Test／Anchors/Planeは環境対応時のみ）
3. **B: Fallback層**（スクリーン座標ベース、擬似Z、慣性）
4. three.jsでMMD表示（MMDLoader）
5. MediaPipe Tasks Hand Landmarker（WASM）
6. ジェスチャー→操作マッピング（掴む/移動/回転/スケール）
7. **モデル追加UI/UX**（ユーザ選択で読み込み、最近使った、エラー提示）
8. 設定UI（解像度、推論負荷、XRモード、品質、物理ON/OFF、HUD）
9. ローカルのみ（外部送信なし）、規約遵守

### 1.3 非スコープ（今回やらない）

* 高精度/長距離SLAM保存（本番検討項目）
* 高コストGI/SSR/レイトレ、布/髪など高度物理
* 公開配布（モデル規約回避のため**ローカルPoC専用**）

---

## 2. 対象環境・依存

* **OS**: macOS（Apple Silicon推奨）。Windowsは任意対応。
* **Electron**: 現行安定版（ChromiumのWebXR実装/MediaStream/WASM性能が十分な範囲）。
* **three.js**: 現行安定版（`MMDLoader`, `MMDAnimationHelper`は導入準備のみ）。
* **MediaPipe**: **Tasks版 Hand Landmarker（WASM）**。
* **GPU**: ハードウェアアクセラレーション有効。
* **カメラ**: 1080p要求、降格ロジックあり（720p→480p）。

---

## 3. 機能要件（詳細）

### 3.1 モデル追加（ユーザ選択で読み込み）

**目的**: 規約順守のため、**ユーザ自身のローカル資産を選択して読み込む**。
**入力**: `.pmx`（必須）、同ディレクトリまたは相対パスの `.png/.jpg` 等テクスチャ
**UI/UX**:

* メニュー「ファイル > モデルを開く…」(`Cmd/Ctrl+O`) → `dialog.showOpenDialog`（Main）

  * フィルタ: `[".pmx"]`（将来拡張で `.pmd/.vrm` 追加可能だが本PoCは `.pmx` 想定）
* **ドラッグ&ドロップ**（Rendererキャンバスへ）: `.pmx` を受理
* **最近使ったモデル**（最大10件）: パス表示、存在しなければリストから自動除外
* **読み込み進捗**: モーダル（%表示）＋キャンセル
* **検証**:

  * 拡張子チェック、ファイル存在、サイズ上限（例: 200MB）
  * 相対テクスチャ解決（`/../textures/xxx.png` 等）
  * テクスチャ最大辺オプション（例: 4096まで。超過時は**ダウンサンプル**提示）
* **失敗時**: 明確なエラーダイアログ（原因/対処：欠損テクスチャ、非対応エンコーディング、VRAM不足 等）
* **保存**: 現在シーン（モデルの位置/回転/スケール、XRモード、品質）をローカル保存（`electron-store`）

**資産リゾルバ**:

* ベースディレクトリ＝選択 `.pmx` の所在ディレクトリ
* 相対参照（`..\tex\xxx.png` など）を**正規化**・**ディレクトリトラバーサル防止**
* 同一URLの重複ロードを避けるキャッシュ（テクスチャ/バイナリ）
* 欠損時は**プレースホルダ**テクスチャを適用しつつ警告

**典型スケール**:

* three.jsのワールド単位＝**メートル**仮定、PMXはモデルによりサイズ差異
* 初期配置時の**自動フィット**（バウンディングボックスを画面高の 30–40% へ収める）

---

### 3.2 XR層（A: WebXR Hit Testベース）

* `navigator.xr.isSessionSupported('immersive-ar')` で可否判定
* セッション開始: `immersive-ar`、`requiredFeatures: ["hit-test"]`（Anchors/Planeは**存在時のみ**追加）
* Hit Test:

  * 画面中心レイ（またはタップ位置レイ）から `XRHitTestResult` を取得
  * **リテイクル**表示（視覚的設置プレビュー）
  * 設置確定で**アンカー**作成（可能な場合）。不可なら**最新ポーズ**で固定
* three.js統合:

  * `XRCamera` のビュープロジェクション同期
  * 取得ポーズを3Dオブジェクトの**親ノード**に反映（アンカー配下）
* 既存オブジェクトの**再配置**: 再度ヒットした位置へスナップ（スムース補間）
* 背景合成: WebXRのカメラパススルー（不可ならVideo合成）

### 3.3 Fallback層（B: スクリーン座標）

* 背景: `<video>`（1080p要求、降格あり）
* 座標系: スクリーン座標を**擬似平面（Z=一定）**へ**レイキャスト**して移動
* 擬似Z: 両手距離 or ピンチ強度からZ位置を線形/指数で変換（範囲例: 0.3–2.5m）
* 回転: **手首向き**または**親指–小指ベクトル**のスクリーン角度 → Yaw回転
* 慣性: 追従は**速度制限**＋**加速度スロープ**で過度な跳ねを抑制

---

### 3.4 手トラッキング（共通）

* **MediaPipe Tasks Hand Landmarker（WASM）**
* 最大手数: 2
* **推論入力解像度**は**別管理**（例: 360p/480p/720p）

  * 表示は1080p維持、推論のみ縮小で遅延低減
* **平滑化**:

  * 位置EMA: `p_smooth = α * p_raw + (1 - α) * p_prev`（例: α=0.5）
  * 角度EMA: 同様に適用（例: α=0.7）
  * One Euro Filterの**cutoff/mincutoff/beta**もUIで選択可能（デフォルトEMA）
* **ジェスチャー定義**（初期値・UIで可変）

  * 掴む/離す: 指先距離 `d(thumb,index) < T_grab` → 掴む、`> T_release` → 離す

    * 例: `T_grab = 0.035（正規化）`, `T_release = 0.045`（ヒステリシス）
  * スケール: **両手中心距離**比で `scale = k * (dist / dist0)`（k=1.0）
  * 回転: **手首ベクトル**の水平角度差分をY軸回転へ
  * 移動: 掴み中のみ、**手の中心**（手首/中手基部の平均）を基準
* **キャリブレーション**:

  * 初回起動時に**ピンチ→離す**のサイクルを実施して**個人差**を補正（T\_grab/T\_release自動推定）

---

### 3.5 物理/レンダリング（任意）

* 物理: `cannon-es`（床剛体 + モデルの簡易剛体）

  * A系ではHit Test平面法線を床平面へ反映
  * FPS確保のため**簡易衝突**のみ（凸包/球近似）
* 影: 受け影 or 擬似シャドウ（半透明デカール）
* 品質プリセット: **低/中/高**

  * 低: 影なし、ポストなし
  * 中: 受け影あり、PMREM軽量
  * 高: 受け影+環境マップ強化（fps低下に注意）

---

## 4. 非機能要件

### 4.1 性能（目標）

* 表示: **1080p/30fps**目標（最低24fps）
* 体感遅延: **≤120ms**（A系）、**≤150ms**（B系）
* 推論: 15–30fps（UIで間引き可）
* テクスチャ総メモリ目安: 512MB以内（超過時は縮小/ミップ制限を促す）

### 4.2 可用性・自動切替

* 起動時に `isSessionSupported('immersive-ar')` を評価 →
  **可**: A系を既定 / **不可**: B系へ自動切替
* UIで**手動切替**可能（A失敗時は即B、B→Aは再トライ）

### 4.3 セキュリティ/プライバシー

* `contextIsolation: true`, `sandbox: true`, `nodeIntegration: false`
* IPCは**限定チャンネル**で**スキーマ検証**
* ファイル読み込みは**拡張子/シグネチャ/サイズ上限**、パス正規化でディレクトリトラバーサル防止
* カメラ映像/ランドマーク座標は**外部送信しない**

### 4.4 ロギング/可観測性

* HUD: display fps / inference fps / inference ms / XRモード / 検出手数 / 信頼度
* ログレベル: INFO/DEBUG 切替（ファイル出力は任意）

---

## 5. UI/UX要件

### 5.1 画面構成

* **上部バー**: 「開く」「最近」「XRモード(Auto/XR/FB)」「解像度(1080p/720p)」「推論解像度(360/480/720p)」「品質(低/中/高)」「物理ON/OFF」「HUD」
* **表示領域**: 背景（XRパススルー or `<video>`）＋ three.js Canvas
* **リテイクル**（A系）: Hit Test位置に半透明ターゲット
* **モデルギズモ**（ON/OFF）: 中心/回転/スケールの簡易可視化
* **ヘルプ**: ジェスチャー一覧・ショートカット

### 5.2 入出力／操作

* `Cmd/Ctrl+O`: モデルを開く
* `R`: トランスフォーム初期化
* `H`: HUD切替
* `Space`: 一時停止/再開
* ドラッグ&ドロップ: `.pmx` 受け付け

---

## 6. データ・設定

### 6.1 設定スキーマ（例 / JSON）

```json
{
  "displayResolution": "1080p",
  "inferenceResolution": "480p",
  "xrMode": "auto",              // "auto" | "xr" | "fallback"
  "quality": "medium",           // "low" | "medium" | "high"
  "physics": false,
  "hud": true,
  "gesture": {
    "grab": 0.035,
    "release": 0.045,
    "scaleFactor": 1.0,
    "rotationGain": 1.0,
    "moveGain": 1.0
  },
  "smoothing": {
    "type": "ema",               // "ema" | "one_euro"
    "alphaPos": 0.5,
    "alphaRot": 0.7
  },
  "recentModels": [
    { "path": "/Users/you/model.pmx", "lastOpenedAt": 1724140800000 }
  ],
  "scene": {
    "position": [0, 0, -1.2],
    "rotationEuler": [0, 0, 0],
    "scale": 1.0
  }
}
```

### 6.2 IPC契約（TypeScript型 例）

```ts
// Main -> Renderer
type OpenModelDialogResult = { canceled: boolean; filePath?: string };

// Renderer -> Main
type IPC = {
  "dialog/open-model": () => Promise<OpenModelDialogResult>;
  "settings/get": () => Promise<AppSettings>;
  "settings/set": (next: Partial<AppSettings>) => Promise<void>;
};
```

---

## 7. アーキテクチャ

### 7.1 構成

```
/project
  ├─ main/               # Electron Main（権限、ダイアログ、設定）
  ├─ renderer/
  │   ├─ xr/             # XR層（A: Hit Test, Anchors/Planeは存在時のみ）
  │   ├─ fb/             # Fallback層（スクリーン座標）
  │   ├─ vision/         # MediaPipe Tasks（初期化・推論・平滑化）
  │   ├─ mmd/            # MMDLoader, 資産リゾルバ, テクスチャ制御
  │   ├─ gestures/       # ピンチ/距離/向き→操作マッピング
  │   ├─ ui/             # 設定パネル、HUD、ダイアログ
  │   └─ core/           # three.js Scene/Cam/光源/レンダラ
  └─ shared/             # 型定義、設定スキーマ
```

### 7.2 更新ループ（共通）

1. カメラフレーム取得（XRまたはVideo）
2. **推論**（Hand Landmarker / 可変解像度 / fps間引き）
3. **平滑化**（EMA/OneEuro）
4. **ジェスチャー解釈** → 目標Transform
5. **A**: Hit Test/アンカー結果 → 目標Transformへ融合
   **B**: レイキャスト/擬似平面 → 目標Transform
6. three.jsへ適用 → 描画
7. HUD更新

---

## 8. テスト計画・受入基準

### 8.1 正常系

* **モデル追加**:

  * `.pmx`選択→テクスチャ解決→シーンへ表示（< 5s/200MB以内）
  * 欠損テクスチャ時に警告表示＋プレースホルダ適用
  * 最近リストから再オープン可／欠損時は自動除外
* **XR可否**:

  * 対応環境で `immersive-ar` セッション開始→Hit Testレティクル表示→設置→アンカー固定（可能時）
  * 非対応環境でB系へ自動切替
* **ジェスチャー**:

  * 掴む/離すのヒステリシスが動作、掴み中のみ移動/回転/スケールが適用
* **性能**:

  * 1080p/表示30fps目標（最低24fps）、推論fpsが設定で変化

### 8.2 失敗系/境界

* カメラ拒否→明示エラー→ダミー映像でUI確認可
* 1080p取得不可→自動降格（720p→480p）
* 大容量PMX（>200MB）→警告ダイアログ（続行/中止）
* XRセッション中断→B系へフェイルバック
* 10分連続動作でfps/メモリの異常増加がない（リーク監視）

### 8.3 受入判定（最終）

* **A系**: Hit Testによる**平面設置**→（対応時）**アンカー固定**→手操作（掴む/移動/回転/拡大縮小）を**体感遅延≤120ms**で実演
* **B系**: 同操作を**24fps以上**で安定表示
* モデル追加が**ユーザ主導**で完遂、最近リスト・エラー提示が適切
* 外部送信なし、規約注意がUI/Docsに明記

---

## 9. リスクと対策

| リスク           | 内容                        | 対策                       |
| ------------- | ------------------------- | ------------------------ |
| WebXR-ARの可用性差 | Electron/デスクトップでARが無効なケース | 起動時判定でBへ自動切替、UIに明示       |
| 1080pで負荷増     | 熱/遅延上昇                    | 推論解像度分離、fps間引き、品質低下プリセット |
| PMX差異         | テクスチャ解像度/参照経路の相違          | 資産リゾルバ＋上限縮小＋エラーダイアログ     |
| 誤検出           | 指遮蔽/照度変化                  | 平滑化・ヒステリシス・掴み中限定操作       |
| 規約違反          | モデルの配布/同梱                 | ユーザ選択のみ、同梱禁止、非公開PoC明記    |

---

## 10. 運用・ドキュメント

* セットアップ手順（Node/Electron/three/MediaPipe）
* カメラ権限ガイド（OS設定含む）
* モデル追加の手順（推奨ディレクトリ構成、テクスチャ上限）
* XRトラブルシュート（A→B切替方法、ドライバ/フラグ注意）
* 規約・ライセンス注意（**ユーザ資産のみ**、配布禁止、研究用途）

---

## 11. 実装メモ（抜粋）

* **テクスチャ縮小**: 読み込み時に`createImageBitmap`→`canvas`で最大辺リサイズ（品質: medium）
* **Reticle描画**: 半透明円＋法線矢印（A系）
* **慣性**: `v = clamp(v + a*dt, vmax)` / `p += v*dt`、掴み解除で減衰
* **座標整合**: 初期配置は**カメラ前方1–1.5m**相当（B系はZ固定から開始）

---

## 12. 今後の拡張候補

* `.vrm`対応、表情/ボーン制御（ハンド→リグ駆動）
* 平面ラベル（床/机）や境界ポリゴン反映
* 画像ベース照明（IBL）・KTX2圧縮
* シーン保存/読み込み（複数オブジェクト）

---

### 付録A：モデル追加の詳細フロー

1. ユーザ操作（メニュー/ドラッグ&ドロップ）
2. Mainでパスを取得→RendererへIPC返却
3. Rendererの資産リゾルバが`.pmx`解析→相対テクスチャ列挙
4. 拡張子/サイズ/存在チェック→キャッシュ→必要なら縮小
5. three.js `MMDLoader`で非同期ロード（進捗UI）
6. 初期Transform（自動フィット）→シーン追加
7. `recentModels`更新・保存

---

