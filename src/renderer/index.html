<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'nonce-pocxr-2025' blob: 'unsafe-eval'; worker-src 'self' blob:; style-src 'self'; img-src 'self' data: blob:; font-src 'self'; connect-src 'self' blob: data:; media-src 'self' blob:; frame-src 'none'; base-uri 'none'" />
    <title>PoC-XR</title>
    <script type="importmap" nonce="pocxr-2025">
      {
        "imports": {
          "three": "../../node_modules/three/build/three.module.js",
          "three/addons/": "../../node_modules/three/examples/jsm/",
          "@mediapipe/tasks-vision": "../../node_modules/@mediapipe/tasks-vision/vision_bundle.mjs"
        }
      }
    </script>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div id="toolbar">
      <button id="btn-open">開く</button>
      <select id="sel-xr">
        <option value="auto">XRモード: Auto</option>
        <option value="xr">XR</option>
        <option value="fb">FB</option>
      </select>
      <select id="sel-reso">
        <option value="1080p">解像度: 1080p</option>
        <option value="720p">720p</option>
        <option value="480p">480p</option>
      </select>
      <select id="sel-infer">
        <option value="30">推論: 30fps</option>
        <option value="24">24fps</option>
        <option value="15">15fps</option>
      </select>
      <select id="sel-quality">
        <option value="medium">品質: 中</option>
        <option value="low">低</option>
        <option value="high">高</option>
      </select>
      <select id="sel-texmax">
        <option value="0">最大辺: 無制限</option>
        <option value="4096">4096</option>
        <option value="2048">2048</option>
        <option value="1024">1024</option>
      </select>
      <label class="inline">
        <input id="chk-physics" type="checkbox"> 物理
      </label>
      <select id="sel-recent">
        <option value="">最近</option>
      </select>
      <button id="btn-replace" title="XR再配置">再配置</button>
      <button id="btn-gest" title="ジェスチャー調整">調整</button>
      <button id="btn-verify" title="受入基準の自己検証">検証</button>
      <span id="status"></span>
    </div>

    <div id="stage">
      <video id="bg" autoplay playsinline muted></video>
      <canvas id="gl"></canvas>
      <div id="hud"></div>
      <div id="asset-hint" hidden>手検出モデル未配置: assets/hand_landmarker.task を配置</div>
      <div id="xr-hint" hidden>XR: 掴んで設置、再配置でやり直し</div>
      <div id="drop-hint" hidden>ここに .pmx をドロップ</div>
      <div id="modal" hidden>
        <div class="panel">
          <div class="title">読み込み</div>
          <div id="modal-msg">初期化中</div>
          <div class="bar"><div id="bar-inner"></div></div>
          <div id="modal-errors"></div>
        </div>
      </div>

      <div id="gest-panel" hidden>
        <div class="panel">
          <div class="title">ジェスチャー調整</div>
          <div class="row">
            <label>しきい値 T_grab: <span id="val-tgrab"></span></label>
            <input id="in-tgrab" type="range" min="0.010" max="0.120" step="0.001">
          </div>
          <div class="row">
            <label>しきい値 T_release: <span id="val-trel"></span></label>
            <input id="in-trel" type="range" min="0.015" max="0.150" step="0.001">
          </div>
          <div class="row">
            <label>フィルタ: </label>
            <select id="in-filter">
              <option value="ema">EMA</option>
              <option value="oneeuro">OneEuro</option>
            </select>
          </div>
          <div class="row ema-only">
            <label>位置EMA α: <span id="val-posa"></span></label>
            <input id="in-posa" type="range" min="0.05" max="1.00" step="0.05">
          </div>
          <div class="row ema-only">
            <label>角度EMA α: <span id="val-rota"></span></label>
            <input id="in-rota" type="range" min="0.05" max="1.00" step="0.05">
          </div>
          <div class="row oneeuro-only">
            <label>minCutoff: <span id="val-minc"></span></label>
            <input id="in-minc" type="range" min="0.10" max="5.00" step="0.10">
          </div>
          <div class="row oneeuro-only">
            <label>beta: <span id="val-beta"></span></label>
            <input id="in-beta" type="range" min="0.00" max="1.00" step="0.05">
          </div>
          <div class="row oneeuro-only">
            <label>dCutoff: <span id="val-dc"></span></label>
            <input id="in-dc" type="range" min="0.10" max="5.00" step="0.10">
          </div>
          <div class="row">
            <button id="btn-calib">キャリブレーション開始</button>
            <span id="calib-status"></span>
          </div>
          <div class="row end">
            <button id="btn-gest-save">保存</button>
            <button id="btn-gest-close">閉じる</button>
          </div>
        </div>
      </div>

      <div id="verify-panel" hidden>
        <div class="panel">
          <div class="title">受入基準の自己検証</div>
          <div class="row"><span>モード</span><span id="ver-mode"></span></div>
          <div class="row"><span>fps</span><span id="ver-fps"></span></div>
          <div class="row"><span>推論(ms)</span><span id="ver-infer"></span></div>
          <div class="row"><span>検出手数</span><span id="ver-hands"></span></div>
          <div class="row"><span>遅延推定(ms)</span><span id="ver-lat"></span></div>
          <div class="row"><span>判定</span><span id="ver-pass"></span></div>
          <div class="row"><span>ログレベル</span>
            <select id="ver-log">
              <option value="info">INFO</option>
              <option value="debug">DEBUG</option>
            </select>
          </div>
          <div class="row end">
            <button id="btn-ver-close">閉じる</button>
          </div>
        </div>
      </div>
    </div>

    <script src="./renderer.js" type="module"></script>
  </body>
  </html>
